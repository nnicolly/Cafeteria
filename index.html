<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cafeteria</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f5f5f5;
    }

    header {
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }

    #root {
      padding: 1rem;
    }

    .nav-btn {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <header class="d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <h1 class="h4 mb-0 me-3">Tech Bistro</h1>

      <button id="nav-home" class="btn btn-outline-primary btn-sm nav-btn">
        Caf√©s
      </button>

      <button id="nav-cart" class="btn btn-outline-secondary btn-sm nav-btn">
        Carrinho
      </button>
    </div>

    <button id="cart-header-btn" class="btn btn-primary btn-sm">
      üõí
      <span>Itens:</span>
      <span id="cart-count">0</span>
    </button>
  </header>

  <main id="root" class="container"></main>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    const API_URL = 'http://localhost:3000/coffee';
    const CART_STORAGE_KEY = 'cart';

    const root = document.getElementById('root');
    const cartCountSpan = document.getElementById('cart-count');
    const navHomeBtn = document.getElementById('nav-home');
    const navCartBtn = document.getElementById('nav-cart');
    const cartHeaderBtn = document.getElementById('cart-header-btn');

    let currentPage = 'home';
    let products = [];
    let cart = [];

    window.addEventListener('load', init);

    async function init() {
      loadCartFromStorage();
      updateCartCountUI();
      await loadProductsFromAPI();
      attachGlobalListeners();
      navigateTo('home');
    }

    async function loadProductsFromAPI() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error('Erro HTTP: ' + response.status);
        }

        const data = await response.json();

        if (Array.isArray(data)) {
          products = data;
        } else if (Array.isArray(data.cafes)) {
          products = data.cafes;
        } else if (Array.isArray(data.coffee)) {
          products = data.coffee;
        } else {
          products = [];
        }
      } catch (error) {
        console.error('Erro ao carregar caf√©s da API', error);
        root.innerHTML =
          '<p class="text-danger">Erro ao carregar caf√©s. Verifique se o json-server est√° rodando.</p>';
      }
    }

    function loadCartFromStorage() {
      try {
        const stored = localStorage.getItem(CART_STORAGE_KEY);
        cart = stored ? JSON.parse(stored) : [];
      } catch (error) {
        console.error('Erro ao ler carrinho do localStorage', error);
        cart = [];
      }
    }

    function saveCartToStorage() {
      try {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
      } catch (error) {
        console.error('Erro ao salvar carrinho no localStorage', error);
      }
    }

    function getCartCount() {
      return cart.reduce((acc, item) => acc + item.quantity, 0);
    }

    function getCartTotal() {
      return cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
    }

    function addItemToCart(productId) {
      const id = Number(productId);
      const product = products.find(p => Number(p.id) === id);

      if (!product) {
        console.warn('Produto n√£o encontrado para id:', id);
        return;
      }

      const existing = cart.find(item => Number(item.id) === id);

      if (existing) {
        existing.quantity += 1;
      } else {
        const name = product.title || product.name || 'Caf√©';
        const image = product.image || product.img || '';
        const price = Number(product.price) || 0;

        cart.push({
          id,
          name,
          price,
          image,
          quantity: 1
        });
      }

      saveCartToStorage();
      updateCartCountUI();
    }

    function removeOneItemFromCart(productId) {
      const id = Number(productId);
      const index = cart.findIndex(item => Number(item.id) === id);

      if (index === -1) return;

      cart[index].quantity -= 1;

      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }

      saveCartToStorage();
      updateCartCountUI();
      if (currentPage === 'cart') {
        renderCartPage();
      }
    }

    function removeItemFromCart(productId) {
      const id = Number(productId);
      cart = cart.filter(item => Number(item.id) !== id);

      saveCartToStorage();
      updateCartCountUI();
      if (currentPage === 'cart') {
        renderCartPage();
      }
    }

    function clearCart() {
      cart = [];
      saveCartToStorage();
      updateCartCountUI();
    }

    function updateCartCountUI() {
      cartCountSpan.textContent = getCartCount();
    }

    function attachGlobalListeners() {
      navHomeBtn.addEventListener('click', () => navigateTo('home'));
      navCartBtn.addEventListener('click', () => navigateTo('cart'));
      cartHeaderBtn.addEventListener('click', () => navigateTo('cart'));
    }

    function navigateTo(page) {
      currentPage = page;

      if (page === 'home') {
        renderHomePage();
      } else if (page === 'cart') {
        renderCartPage();
      } else if (page === 'checkout') {
        renderCheckoutPage();
      }
    }

    function clearRoot() {
      root.innerHTML = '';
    }

    function renderHomePage() {
      clearRoot();

      const title = document.createElement('h2');
      title.textContent = 'Nossos Caf√©s';
      title.className = 'mb-4';
      root.appendChild(title);

      if (!products || products.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'Nenhum caf√© encontrado.';
        root.appendChild(p);
        return;
      }

      const row = document.createElement('div');
      row.className = 'row g-3';

      products.forEach(product => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';

        const card = document.createElement('div');
        card.className = 'card h-100';

        if (product.image || product.img) {
          const img = document.createElement('img');
          img.className = 'card-img-top';
          img.src = product.image || product.img;
          img.alt = product.title || product.name || 'Caf√©';
          card.appendChild(img);
        }

        const body = document.createElement('div');
        body.className = 'card-body d-flex flex-column';

        const nameEl = document.createElement('h5');
        nameEl.className = 'card-title';
        nameEl.textContent = product.title || product.name || 'Caf√©';
        body.appendChild(nameEl);

        const descEl = document.createElement('p');
        descEl.className = 'card-text small';
        descEl.textContent = product.description || '';
        body.appendChild(descEl);

        if (product.ingredients) {
          const ingredientsEl = document.createElement('p');
          ingredientsEl.className = 'card-text';
          ingredientsEl.innerHTML =
            '<strong>Ingredientes:</strong> ' + product.ingredients;
          body.appendChild(ingredientsEl);
        }

        const priceEl = document.createElement('p');
        priceEl.className = 'card-text fw-bold';
        const priceNumber = Number(product.price) || 0;
        priceEl.textContent = 'Pre√ßo: R$ ' + priceNumber.toFixed(2);
        body.appendChild(priceEl);

        const button = document.createElement('button');
        button.className = 'btn btn-primary mt-auto';
        button.textContent = 'Adicionar ao carrinho';
        button.addEventListener('click', () => addItemToCart(product.id));
        body.appendChild(button);

        card.appendChild(body);
        col.appendChild(card);
        row.appendChild(col);
      });

      root.appendChild(row);
    }

    function renderCartPage() {
      clearRoot();

      const title = document.createElement('h2');
      title.textContent = 'Carrinho de Compras';
      title.className = 'mb-4';
      root.appendChild(title);

      if (!cart || cart.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'Seu carrinho est√° vazio.';
        root.appendChild(p);
        return;
      }

      const table = document.createElement('table');
      table.className = 'table table-striped align-middle';

      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Produto</th>
          <th class="text-end">Pre√ßo</th>
          <th class="text-center">Qtd.</th>
          <th class="text-end">Subtotal</th>
          <th class="text-center">A√ß√µes</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      cart.forEach(item => {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = item.name;
        tr.appendChild(tdName);

        const tdPrice = document.createElement('td');
        tdPrice.className = 'text-end';
        tdPrice.textContent = 'R$ ' + Number(item.price).toFixed(2);
        tr.appendChild(tdPrice);

        const tdQty = document.createElement('td');
        tdQty.className = 'text-center';
        tdQty.textContent = item.quantity;
        tr.appendChild(tdQty);

        const tdSub = document.createElement('td');
        tdSub.className = 'text-end';
        const subtotal = Number(item.price) * item.quantity;
        tdSub.textContent = 'R$ ' + subtotal.toFixed(2);
        tr.appendChild(tdSub);

        const tdActions = document.createElement('td');
        tdActions.className = 'text-center';

        const btnMinus = document.createElement('button');
        btnMinus.className = 'btn btn-sm btn-outline-secondary me-1';
        btnMinus.textContent = '-';
        btnMinus.addEventListener('click', () =>
          removeOneItemFromCart(item.id)
        );

        const btnPlus = document.createElement('button');
        btnPlus.className = 'btn btn-sm btn-outline-secondary me-1';
        btnPlus.textContent = '+';
        btnPlus.addEventListener('click', () =>
          addItemToCart(item.id)
        );

        const btnRemove = document.createElement('button');
        btnRemove.className = 'btn btn-sm btn-outline-danger';
        btnRemove.textContent = 'Remover';
        btnRemove.addEventListener('click', () =>
          removeItemFromCart(item.id)
        );

        tdActions.appendChild(btnMinus);
        tdActions.appendChild(btnPlus);
        tdActions.appendChild(btnRemove);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      root.appendChild(table);

      const totalDiv = document.createElement('div');
      totalDiv.className =
        'd-flex justify-content-between align-items-center mt-3';

      const totalText = document.createElement('h5');
      totalText.className = 'mb-0';
      totalText.textContent =
        'Total: R$ ' + getCartTotal().toFixed(2);

      const btnCheckout = document.createElement('button');
      btnCheckout.className = 'btn btn-success';
      btnCheckout.textContent = 'Finalizar Compra';
      btnCheckout.addEventListener('click', () => navigateTo('checkout'));

      totalDiv.appendChild(totalText);
      totalDiv.appendChild(btnCheckout);

      root.appendChild(totalDiv);
    }

    function renderCheckoutPage() {
      clearRoot();

      const title = document.createElement('h2');
      title.textContent = 'Finaliza√ß√£o da Compra';
      title.className = 'mb-4';
      root.appendChild(title);

      if (!cart || cart.length === 0) {
        const p = document.createElement('p');
        p.textContent =
          'Seu carrinho est√° vazio. Adicione itens antes de finalizar a compra.';
        root.appendChild(p);
        return;
      }

      const summaryCard = document.createElement('div');
      summaryCard.className = 'card mb-4';
      const summaryBody = document.createElement('div');
      summaryBody.className = 'card-body';

      const summaryTitle = document.createElement('h5');
      summaryTitle.className = 'card-title';
      summaryTitle.textContent = 'Resumo do Pedido';
      summaryBody.appendChild(summaryTitle);

      const ul = document.createElement('ul');
      ul.className = 'list-group list-group-flush';

      cart.forEach(item => {
        const li = document.createElement('li');
        li.className =
          'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `${item.quantity}x ${item.name}`;
        const span = document.createElement('span');
        span.textContent =
          'R$ ' + (item.price * item.quantity).toFixed(2);
        li.appendChild(span);
        ul.appendChild(li);
      });

      const totalLi = document.createElement('li');
      totalLi.className =
        'list-group-item d-flex justify-content-between align-items-center fw-bold';
      totalLi.textContent = 'Total';
      const totalSpan = document.createElement('span');
      totalSpan.textContent = 'R$ ' + getCartTotal().toFixed(2);
      totalLi.appendChild(totalSpan);
      ul.appendChild(totalLi);

      summaryBody.appendChild(ul);
      summaryCard.appendChild(summaryBody);
      root.appendChild(summaryCard);

      const formCard = document.createElement('div');
      formCard.className = 'card';
      const formBody = document.createElement('div');
      formBody.className = 'card-body';

      const formTitle = document.createElement('h5');
      formTitle.className = 'card-title mb-3';
      formTitle.textContent = 'Dados para Entrega e Pagamento';
      formBody.appendChild(formTitle);

      const form = document.createElement('form');

      const addressGroup = document.createElement('div');
      addressGroup.className = 'mb-3';
      const addressLabel = document.createElement('label');
      addressLabel.className = 'form-label';
      addressLabel.textContent = 'Endere√ßo de entrega';
      const addressInput = document.createElement('input');
      addressInput.type = 'text';
      addressInput.className = 'form-control';
      addressInput.required = true;
      addressGroup.appendChild(addressLabel);
      addressGroup.appendChild(addressInput);

      const paymentGroup = document.createElement('div');
      paymentGroup.className = 'mb-3';
      const paymentLabel = document.createElement('label');
      paymentLabel.className = 'form-label';
      paymentLabel.textContent = 'M√©todo de pagamento';
      const paymentSelect = document.createElement('select');
      paymentSelect.className = 'form-select';
      paymentSelect.required = true;

      const optionDefault = document.createElement('option');
      optionDefault.value = '';
      optionDefault.textContent = 'Selecione uma op√ß√£o';
      optionDefault.disabled = true;
      optionDefault.selected = true;

      const optionCard = document.createElement('option');
      optionCard.value = 'cartao';
      optionCard.textContent = 'Cart√£o de cr√©dito';

      const optionBoleto = document.createElement('option');
      optionBoleto.value = 'boleto';
      optionBoleto.textContent = 'Boleto';

      const optionPix = document.createElement('option');
      optionPix.value = 'pix';
      optionPix.textContent = 'PIX';

      paymentSelect.appendChild(optionDefault);
      paymentSelect.appendChild(optionCard);
      paymentSelect.appendChild(optionBoleto);
      paymentSelect.appendChild(optionPix);

      paymentGroup.appendChild(paymentLabel);
      paymentGroup.appendChild(paymentSelect);

      const errorDiv = document.createElement('div');
      errorDiv.className = 'text-danger mb-2';
      errorDiv.style.display = 'none';

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.className = 'btn btn-success';
      submitBtn.textContent = 'Finalizar';

      form.appendChild(addressGroup);
      form.appendChild(paymentGroup);
      form.appendChild(errorDiv);
      form.appendChild(submitBtn);

      form.addEventListener('submit', function (event) {
        event.preventDefault();

        const address = addressInput.value.trim();
        const payment = paymentSelect.value;

        if (!address || !payment) {
          errorDiv.textContent = 'Preencha o endere√ßo e selecione o m√©todo de pagamento.';
          errorDiv.style.display = 'block';
          return;
        }

        errorDiv.style.display = 'none';

        alert('Compra finalizada com sucesso! Obrigado.');

        clearCart();
        navigateTo('home');
      });

      formBody.appendChild(form);
      formCard.appendChild(formBody);
      root.appendChild(formCard);
    }
  </script>
</body>
</html>
